<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>DFI • EXEC Dashboard</title>
  <link rel="stylesheet" href="assets/style.css">
</head>
<body data-page="exec">
  <div class="app">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sb-logo" title="DFI Portal" onclick="location.reload()"></div>
      <button class="sb-btn active" title="Dashboard">
        <span class="ico"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M3 10.5 12 3l9 7.5V21a1 1 0 0 1-1 1h-5v-7H9v7H4a1 1 0 0 1-1-1v-10.5Z"></path></svg></span>
      </button>
      <a class="sb-btn" title="Add Case" href="addcase_exec.html">
        <span class="ico"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M12 5v14M5 12h14"></path></svg></span>
      </a>
      <div class="sb-spacer"></div>
      <button class="sb-btn" id="btnLogoutMini" title="Logout">
        <span class="ico"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M10 17l5-5-5-5"></path><path d="M15 12H3"></path><path d="M21 3v18"></path></svg></span>
      </button>
    </aside>

    <!-- CONTENT -->
    <div class="content">
      <header class="topbar">
        <div class="tb-left">
          <div class="tb-title">
            <b>Digital Fraud Investigation</b>
            <span>EXEC Workspace • Protected</span>
          </div>
        </div>
        <div class="search">
          <span class="ico"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><circle cx="11" cy="11" r="7"></circle><path d="M20 20l-3.5-3.5"></path></svg></span>
          <input id="searchInput" placeholder="Search by Case ID...">
          <span class="kbd">Ctrl K</span>
        </div>
        <div class="tb-right">
          <span class="pill role" id="whoRole">-</span>
          <span class="pill" id="whoName">Loading…</span>
          <div class="avatar"><span class="ico"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M20 21a8 8 0 1 0-16 0"></path><circle cx="12" cy="9" r="3"></circle></svg></span></div>
          <button class="btn danger" id="btnLogout">Logout</button>
        </div>
      </header>

      <main class="page">
        <div class="container">
          <div class="h1">
            <div>
              <h2>Case Overview</h2>
              <p id="viewMode">Loading cases...</p>
            </div>
            <a class="btn green" href="addcase_exec.html">+ New Case</a>
          </div>

          <!-- KPI Cards -->
          <div class="grid-cards">
            <div class="card"><div class="k">Total Cases</div><div class="v" id="kpiTotal">—</div><div class="s">All my cases</div></div>
            <div class="card"><div class="k">Work in Progress</div><div class="v" id="kpiWip">—</div><div class="s">Status ≠ Closed</div></div>
            <div class="card"><div class="k">Fraud Cases</div><div class="v" id="kpiFraud">—</div><div class="s">Classification</div></div>
            <div class="card"><div class="k">Avg. TAT (days)</div><div class="v" id="kpiTat">—</div><div class="s">Operational metric</div></div>
          </div>

          <!-- Loading Section -->
          <section class="section" id="loadingSection">
            <div class="section-h"><b>Loading</b><span>Fetching data...</span></div>
            <div class="section-b">
              <div class="skel h36" style="width:220px;margin-bottom:12px"></div>
              <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px">
                <div class="skel h320"></div><div class="skel h320"></div><div class="skel h320"></div><div class="skel h320"></div>
              </div>
            </div>
          </section>

          <!-- Main Table -->
          <section class="section" id="mainSection" style="display:none">
            <div class="section-h"><b>Cases</b><span id="caseCount">0 records</span></div>
            <div class="section-b" style="padding:0">
              <table class="table">
                <thead>
                  <tr><th>Case ID</th><th>Name</th><th>Type</th><th>Status</th><th>Date Escalated</th><th>TAT</th><th>Actions</th></tr>
                </thead>
                <tbody id="tblBody"></tbody>
              </table>
              <div class="empty-state hidden" id="emptyState">
                <h4>No cases found</h4>
                <p>Create a new case to get started</p>
              </div>
            </div>
          </section>
        </div>
      </main>
    </div>
  </div>

  <!-- Close Case Modal -->
  <div class="modal-overlay" id="closeModal">
    <div class="modal">
      <div class="modal-header"><h3>Close Case</h3><button class="modal-close" onclick="closeModal('closeModal')">×</button></div>
      <div class="modal-body">
        <p>Case: <strong id="closeCaseId"></strong></p>
        <div class="form-group" style="margin-top:16px">
          <label class="form-label">Resolution</label>
          <select id="closeResolution" class="inp"><option value="Resolved">Resolved</option><option value="No Action">No Action Required</option><option value="Escalated">Escalated</option></select>
        </div>
        <div class="form-group" style="margin-top:12px">
          <label class="form-label">Closing Remarks *</label>
          <textarea id="closeRemarks" class="inp" rows="3" required></textarea>
        </div>
        <div id="closeMsg" style="margin-top:12px;font-size:12px"></div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closeModal('closeModal')">Cancel</button>
        <button class="btn green" id="confirmClose">Confirm Close</button>
      </div>
    </div>
  </div>

  <script src="js/config.js"></script>
  <script>
    const $ = id => document.getElementById(id);
    let currentUser = null, allCases = [], closingCaseId = null;

    document.addEventListener('DOMContentLoaded', async () => {
      if (!await Auth.requireRole([CONFIG.ROLES.EXEC, CONFIG.ROLES.SUPERADMIN])) return;
      currentUser = Auth.getUser();
      $('whoName').textContent = currentUser.username;
      $('whoRole').textContent = currentUser.role.toUpperCase();
      
      await loadCases();
      setupListeners();
    });

    function setupListeners() {
      $('btnLogout').onclick = () => Auth.logout();
      $('btnLogoutMini').onclick = () => Auth.logout();
      $('searchInput').addEventListener('input', Utils.debounce(applyFilters, 300));
      $('confirmClose').onclick = confirmCloseCase;
    }

    async function loadCases() {
      try {
        const res = await API.get('/exec/cases');
        allCases = res.cases || [];
        updateKPIs();
        applyFilters();
        $('loadingSection').style.display = 'none';
        $('mainSection').style.display = 'block';
      } catch (err) {
        Utils.showToast(err.message || 'Failed to load', 'error');
      }
    }

    function updateKPIs() {
      const wip = allCases.filter(c => c.status !== 'Closed');
      const fraud = allCases.filter(c => c.type_case === 'Fraud' || c.classification === 'Fraud');
      const tats = allCases.map(c => Utils.calcTAT(c.date_escalated, c.date_closed, c.status)).filter(t => t !== null);
      const avgTat = tats.length ? (tats.reduce((a,b) => a+b, 0) / tats.length).toFixed(1) : '-';
      
      $('kpiTotal').textContent = allCases.length;
      $('kpiWip').textContent = wip.length;
      $('kpiFraud').textContent = fraud.length;
      $('kpiTat').textContent = avgTat;
    }

    function applyFilters() {
      const search = $('searchInput').value.toLowerCase();
      let filtered = allCases;
      
      if (search) {
        filtered = allCases.filter(c => (c.case_id || '').toLowerCase().includes(search));
        $('viewMode').textContent = `Search Mode: All Cases (${filtered.length})`;
      } else {
        $('viewMode').textContent = `My Cases (${filtered.length})`;
      }
      
      renderTable(filtered);
    }

    function renderTable(cases) {
      const tbody = $('tblBody');
      const empty = $('emptyState');
      
      if (!cases.length) {
        tbody.innerHTML = '';
        empty.classList.remove('hidden');
        $('caseCount').textContent = '0 records';
        return;
      }
      
      empty.classList.add('hidden');
      $('caseCount').textContent = `${cases.length} records`;
      
      tbody.innerHTML = cases.map(c => {
        const tat = Utils.calcTAT(c.date_escalated, c.date_closed, c.status);
        const typeTag = c.type_case === 'Fraud' ? 'green' : c.type_case === 'Scam' ? 'blue' : '';
        const statusTag = c.status === 'Closed' ? '' : 'red';
        const isPIC = c.pic === currentUser.id;
        
        return `<tr>
          <td class="mono"><b>${Utils.escapeHtml(c.case_id)}</b></td>
          <td>${Utils.escapeHtml(c.customer_name || c.name || '-')}</td>
          <td><span class="tag ${typeTag}">${c.type_case || c.classification || '-'}</span></td>
          <td><span class="tag ${statusTag}">${c.status === 'Closed' ? 'Closed' : 'WIP'}</span></td>
          <td>${Utils.formatDate(c.date_escalated)}</td>
          <td>${Utils.tatBadgeHTML(tat)}</td>
          <td>
            <button class="btn small" onclick="viewCase('${c.id}')">View</button>
            ${c.status !== 'Closed' ? `<button class="btn small danger" onclick="openCloseModal('${c.id}','${Utils.escapeHtml(c.case_id)}',${isPIC})">${isPIC ? 'Close' : 'Request'}</button>` : ''}
          </td>
        </tr>`;
      }).join('');
    }

    function viewCase(id) {
      const c = allCases.find(x => x.id === id);
      if (c) alert(`Case Details:\n\nID: ${c.case_id}\nName: ${c.customer_name || c.name}\nType: ${c.type_case}\nStatus: ${c.status}\nPIC: ${c.pic_name || '-'}`);
    }

    function openCloseModal(id, caseId, isPIC) {
      closingCaseId = id;
      $('closeCaseId').textContent = caseId;
      $('closeRemarks').value = '';
      $('closeMsg').textContent = isPIC ? '' : '⚠️ You are not the PIC. This will create a close request for Senior approval.';
      $('closeMsg').style.color = isPIC ? '' : '#f59e0b';
      $('closeModal').classList.add('active');
    }

    async function confirmCloseCase() {
      const remarks = $('closeRemarks').value.trim();
      const resolution = $('closeResolution').value;
      if (!remarks) { Utils.showToast('Remarks required', 'error'); return; }
      
      const c = allCases.find(x => x.id === closingCaseId);
      const isPIC = c && c.pic === currentUser.id;
      
      Utils.showLoading(isPIC ? 'Closing case...' : 'Submitting request...');
      
      try {
        if (isPIC) {
          await API.patch(`/exec/cases/${closingCaseId}/close`, { remarks, resolution });
          Utils.showToast('Case closed', 'success');
        } else {
          await API.post('/exec/close-requests', { case_id: closingCaseId, remarks, resolution });
          Utils.showToast('Close request submitted for approval', 'success');
        }
        closeModal('closeModal');
        await loadCases();
      } catch (err) {
        Utils.showToast(err.message || 'Failed', 'error');
      } finally {
        Utils.hideLoading();
      }
    }

    function closeModal(id) { $(id).classList.remove('active'); }
    document.querySelectorAll('.modal-overlay').forEach(m => m.addEventListener('click', e => { if (e.target === m) m.classList.remove('active'); }));
  </script>
</body>
</html>
